---
import Badge from '../base/Badge.astro'
import { getResearchAreaColor, getResearchAreaName } from '../../lib/researchAreaColors'

interface Publication {
  id: string
  title: string
  authors: string[]
  year: number
  journal: string
  doi?: string
  impactFactor?: number
  researchAreas?: string[]
  featured?: boolean
  firstAuthor?: boolean
  description?: string
}

interface Props {
  publication: Publication
  number?: number
  class?: string
  style?: string
}

const { publication, number, class: className, style }: Props = Astro.props

// Format authors list (highlight Krasting, J. P.)
const formatAuthors = (authors: string[]) => {
  if (!authors || !Array.isArray(authors) || authors.length === 0) {
    return 'No authors listed'
  }
  return authors.map(author =>
    author.includes('Krasting') ? `<strong>${author}</strong>` : author
  ).join(', ')
}
---

<div class:list={['group relative block py-6 border-b border-border/60 last:border-none', className]} {style}>
  <article class="relative z-1 flex gap-4 transform transition-transform duration-300 group-hover:translate-x-4">
    {number !== undefined && (
      <div class="flex-shrink-0 w-12 sm:w-14 flex items-start justify-end pt-1">
        <span class="text-2xl sm:text-3xl font-bold text-muted-foreground/30 group-hover:text-muted-foreground/50 transition-colors">
          {number}
        </span>
      </div>
    )}
    <div class="flex-1 flex flex-col gap-2">
    <div class="flex sm:items-center gap-2 sm:gap-3 text-sm text-muted-foreground">
      <span class="inline-flex items-center gap-1.5">
        <svg class="size-3.5 sm:size-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
          <line x1="16" y1="2" x2="16" y2="6"/>
          <line x1="8" y1="2" x2="8" y2="6"/>
          <line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
        <time class="text-xs sm:text-sm">
          {publication.year}
        </time>
      </span>
      {publication.journal && (
        <span class="inline-flex items-center gap-1.5">
          <svg class="size-3.5 sm:size-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
          </svg>
          <span class="text-xs sm:text-sm">{publication.journal}</span>
        </span>
      )}
      {publication.impactFactor && (
        <span class="inline-flex items-center gap-1 text-xs sm:text-sm">
          <span class="font-medium">IF: {publication.impactFactor}</span>
        </span>
      )}
    </div>

    <div class="block">
      <div class="text-base font-semibold text-foreground leading-tight group-hover:text-primary transition-colors line-clamp-2">
        {publication.title}
      </div>
      <div class="mt-1.5 text-sm text-muted-foreground/90 leading-5" set:html={formatAuthors(publication.authors)} />
      {publication.description && (
        <p class="mt-1 text-sm text-muted-foreground/80 leading-5 line-clamp-2">{publication.description}</p>
      )}
    </div>

    <div class="flex flex-wrap items-center gap-2">
      {publication.firstAuthor && (
        <Badge type="status" content="First Author" variant="subtle" size="sm" />
      )}
      {publication.featured && (
        <span class="inline-flex items-center rounded-full border border-transparent bg-red-600 text-white px-2.5 py-0.5 text-xs font-semibold transition-colors">
          Featured
        </span>
      )}
      {publication.researchAreas && publication.researchAreas.length > 0 && (
        publication.researchAreas.slice(0, 3).map((area) => {
          const colors = getResearchAreaColor(area);
          const displayName = getResearchAreaName(area);
          const colorClasses = `${colors.bg} ${colors.text} ${colors.border} border`;
          return <Badge type="tag" content={displayName} size="sm" colorClasses={colorClasses} />;
        })
      )}
      {publication.researchAreas && publication.researchAreas.length > 3 && (
        <span class="text-xs text-muted-foreground/60">+{publication.researchAreas.length - 3} more</span>
      )}
    </div>

    {publication.doi && (
      <div class="mt-1">
        <a
          href={`https://doi.org/${publication.doi}`}
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-1 text-xs text-muted-foreground hover:text-primary transition-colors"
        >
          <svg class="size-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
            <polyline points="15 3 21 3 21 9"/>
            <line x1="10" y1="14" x2="21" y2="3"/>
          </svg>
          DOI: {publication.doi}
        </a>
      </div>
    )}
    </div>
  </article>

  <div class="absolute left-0 top-0 h-full w-0.5 sm:w-1 scale-y-0 bg-accent/80 transition-transform duration-300 group-hover:scale-y-100">
  </div>
</div>
